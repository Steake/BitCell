version: '3.8'

services:
  # Region 1: US-East
  node-us-east-1:
    image: bitcell-node:latest
    container_name: bitcell-us-east-1
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    environment:
      - REGION=us-east
      - NODE_ID=us-east-1
      - P2P_PORT=9000
      - RPC_PORT=8545
      - METRICS_PORT=9090
      - BOOTSTRAP_NODES=node-us-west-1:9000,node-eu-central-1:9000
      - DATA_DIR=/data/bitcell
      - LOG_LEVEL=info
    ports:
      - "9000:9000"
      - "8545:8545"
      - "9090:9090"
    volumes:
      - us-east-data:/data/bitcell
    networks:
      bitcell-net:
        ipv4_address: 172.20.0.10
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9090/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  node-us-east-2:
    image: bitcell-node:latest
    container_name: bitcell-us-east-2
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    environment:
      - REGION=us-east
      - NODE_ID=us-east-2
      - P2P_PORT=9001
      - RPC_PORT=8546
      - METRICS_PORT=9091
      - BOOTSTRAP_NODES=node-us-east-1:9000,node-us-west-1:9000
      - DATA_DIR=/data/bitcell
      - LOG_LEVEL=info
    ports:
      - "9001:9001"
      - "8546:8546"
      - "9091:9091"
    volumes:
      - us-east-2-data:/data/bitcell
    networks:
      bitcell-net:
        ipv4_address: 172.20.0.11
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9091/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Region 2: US-West
  node-us-west-1:
    image: bitcell-node:latest
    container_name: bitcell-us-west-1
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    environment:
      - REGION=us-west
      - NODE_ID=us-west-1
      - P2P_PORT=9002
      - RPC_PORT=8547
      - METRICS_PORT=9092
      - BOOTSTRAP_NODES=node-us-east-1:9000,node-eu-central-1:9000
      - DATA_DIR=/data/bitcell
      - LOG_LEVEL=info
    ports:
      - "9002:9002"
      - "8547:8547"
      - "9092:9092"
    volumes:
      - us-west-data:/data/bitcell
    networks:
      bitcell-net:
        ipv4_address: 172.20.0.20
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9092/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  node-us-west-2:
    image: bitcell-node:latest
    container_name: bitcell-us-west-2
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    environment:
      - REGION=us-west
      - NODE_ID=us-west-2
      - P2P_PORT=9003
      - RPC_PORT=8548
      - METRICS_PORT=9093
      - BOOTSTRAP_NODES=node-us-west-1:9002,node-us-east-1:9000
      - DATA_DIR=/data/bitcell
      - LOG_LEVEL=info
    ports:
      - "9003:9003"
      - "8548:8548"
      - "9093:9093"
    volumes:
      - us-west-2-data:/data/bitcell
    networks:
      bitcell-net:
        ipv4_address: 172.20.0.21
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9093/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Region 3: EU-Central
  node-eu-central-1:
    image: bitcell-node:latest
    container_name: bitcell-eu-central-1
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    environment:
      - REGION=eu-central
      - NODE_ID=eu-central-1
      - P2P_PORT=9004
      - RPC_PORT=8549
      - METRICS_PORT=9094
      - BOOTSTRAP_NODES=node-us-east-1:9000,node-us-west-1:9002
      - DATA_DIR=/data/bitcell
      - LOG_LEVEL=info
    ports:
      - "9004:9004"
      - "8549:8549"
      - "9094:9094"
    volumes:
      - eu-central-data:/data/bitcell
    networks:
      bitcell-net:
        ipv4_address: 172.20.0.30
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9094/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  node-eu-central-2:
    image: bitcell-node:latest
    container_name: bitcell-eu-central-2
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    environment:
      - REGION=eu-central
      - NODE_ID=eu-central-2
      - P2P_PORT=9005
      - RPC_PORT=8550
      - METRICS_PORT=9095
      - BOOTSTRAP_NODES=node-eu-central-1:9004,node-us-east-1:9000
      - DATA_DIR=/data/bitcell
      - LOG_LEVEL=info
    ports:
      - "9005:9005"
      - "8550:8550"
      - "9095:9095"
    volumes:
      - eu-central-2-data:/data/bitcell
    networks:
      bitcell-net:
        ipv4_address: 172.20.0.31
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9095/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Region 4: AP-Southeast (Asia Pacific)
  node-ap-southeast-1:
    image: bitcell-node:latest
    container_name: bitcell-ap-southeast-1
    build:
      context: ../..
      dockerfile: infra/docker/Dockerfile
    environment:
      - REGION=ap-southeast
      - NODE_ID=ap-southeast-1
      - P2P_PORT=9006
      - RPC_PORT=8551
      - METRICS_PORT=9096
      - BOOTSTRAP_NODES=node-us-west-1:9002,node-eu-central-1:9004
      - DATA_DIR=/data/bitcell
      - LOG_LEVEL=info
    ports:
      - "9006:9006"
      - "8551:8551"
      - "9096:9096"
    volumes:
      - ap-southeast-data:/data/bitcell
    networks:
      bitcell-net:
        ipv4_address: 172.20.0.40
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9096/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Prometheus for metrics collection
  prometheus:
    image: prom/prometheus:latest
    container_name: bitcell-prometheus
    volumes:
      - ../monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - ../monitoring/alerts.yml:/etc/prometheus/alerts.yml
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
    ports:
      - "9999:9090"
    networks:
      - bitcell-net
    restart: unless-stopped

  # Grafana for visualization
  grafana:
    image: grafana/grafana:latest
    container_name: bitcell-grafana
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:?GRAFANA_ADMIN_PASSWORD must be set}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - ../monitoring/grafana/provisioning:/etc/grafana/provisioning
      - ../monitoring/grafana/dashboards:/var/lib/grafana/dashboards
      - grafana-data:/var/lib/grafana
    ports:
      - "3000:3000"
    networks:
      - bitcell-net
    restart: unless-stopped
    depends_on:
      - prometheus

  # Alertmanager for alerting
  alertmanager:
    image: prom/alertmanager:latest
    container_name: bitcell-alertmanager
    volumes:
      - ../monitoring/alertmanager.yml:/etc/alertmanager/alertmanager.yml
      - alertmanager-data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    ports:
      - "9093:9093"
    networks:
      - bitcell-net
    restart: unless-stopped

  # HAProxy for load balancing
  haproxy:
    image: haproxy:latest
    container_name: bitcell-haproxy
    volumes:
      - ../monitoring/haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro
    ports:
      - "80:80"
      - "443:443"
      - "8404:8404"  # Stats page
    networks:
      - bitcell-net
    restart: unless-stopped
    depends_on:
      - node-us-east-1
      - node-us-west-1
      - node-eu-central-1

networks:
  bitcell-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  us-east-data:
  us-east-2-data:
  us-west-data:
  us-west-2-data:
  eu-central-data:
  eu-central-2-data:
  ap-southeast-data:
  prometheus-data:
  grafana-data:
  alertmanager-data:
